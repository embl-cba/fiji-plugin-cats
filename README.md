
# CATS - Context Aware Trainable Segmentation

## Citation

This github repository can be cited (registered at [ZENODO](https://zenodo.org/)):
- Tischer, C. (2019) CATS, a Fiji plugin for context aware trainable image segmentation. http://doi.org/10.5281/zenodo.2574736

## Overview

CATS is a big image data compatible [Fiji](http://fiji.sc/) plugin for trainable image segmentation. 
The code is partly based on Fiji's [Trainable Weka Segmentation](https://github.com/fiji/Trainable_Segmentation) (TWS) plugin.

Similar to Fiji's [Trainable Weka Segmentation](https://github.com/fiji/Trainable_Segmentation) and the stand-alone software [ilastik](https://www.ilastik.org/), CATS learns an image segmentation from user drawn annotations by computing image features and feeding them into a [Random Forest](https://en.wikipedia.org/wiki/Random_forest) classifier. Again similar to TWS and ilastik, the image features of CATS are based on the Eigenvalues of the [Hessian matrix](https://en.wikipedia.org/wiki/Hessian_matrix) and the [Structure Tensor](https://en.wikipedia.org/wiki/Structure_tensor), which provide rotationally invariant information about edges and ridges in an image's gray-value distribution. 

In order to improve context learning, CATS however also computes "Deep Eigenvalue Features", such as, e.g.:

```
HS( Bin3( SM( Bin3( HL( image ) ) ) ) )
```
, with abbreviations

``` 
HS = Largest Eigenvalue of Hessian Matrix
HS = Smallest Eigenvalue of Hessian Matrix
SM = Middle Eigenvalue of Structure Tensor
Bin3 = 3x3x3 Binning 
```
, where the alteration between image feature computation and image binning is inspired by the architecture of deep convolutional neural networks (DCNN) as, e.g., used in the popular [3D U-Net](https://arxiv.org/abs/1606.06650).

Similar to ilastik, but in contrast to the TWS PlugIn, CATS internally uses a tiling strategy for image segmentation and thus can be applied to arbitrarily large image data sets.

Furthermore, CATS supports:

- 2D and 3D images 
- Time-lapse image data
- Multi-channel image data
- Anisotropic image calibration
- Cluster computing (Slurm)
- Label review

## Usage Examples

- Electron microscopy volume data (e.g., 220 GB)
- Light sheet fluorescence microscopy time-lapse data

## Installation

CATS runs as a PlugIn within Fiji.

- Please install [Fiji](fiji.sc)
- Within Fiji, please enable the following [Update Sites](https://imagej.net/Update_Sites): 
    - [X] EMBL-CBA
    - [X] ImageScience

## Starting CATS

CATS can be found within Fiji's menu tree:

- [Fiji > Plugins > Segmentation > CATS > CATS]

## Using CATS

### Input Image Data

As it is common in Fiji, CATS operates on the currently active image window. Thus, before CATS can be started, one must open an image. As CATS supports multi-channel 2D and 3D time-lapse data any image can be used as input. For analyzing big image data (e.g., data that exceeds the available RAM) ImageJ's VirtualStack functionality should be used; see, e.g., [VirtualStackOpener](https://imagej.nih.gov/ij/plugins/virtual-opener.html) or [BigDataProcessor](https://github.com/tischi/fiji-plugin-bigdataprocessor#big-data-converter) on how to open VirtualStacks.

### Input Image Calibration

Upon start-up CATS asks the user to confirm the image calibration. It is very important that this information is fully correct.

Specifically, please pay attention:

- Are the number of z-planes and frames correct?
    - Sometimes z and t are mixed up...
- Are the voxel sizes in x,y, and z correct?
    - CATS is able to compute anisotropic image features!

### Results Image Setup
  
Next, CATS is providing the user with the opportunity to allocate the results image (containing the pixel probability maps) either in RAM or on disk. We generally recommend using the disk, because (i) there is hardly any performance loss, (ii) results are always saved, and (iii) data larger than RAM can be handled. The data format for storing the temporary pixel probabilities are single plane Tiff files; once the segmentation is finished there are multiple options for export (s.b.). 

##### Tip
  
The following folder structure proved to work well:
  
- `my-segmentation-project`
    - `input-image`
        - put your input image data here
    - `probabilities`
  		- containing the temporary pixel probability maps generated by CATS, i.e. many Tiff files
    - `training`
        - containing training data, i.e. ARFF text files 
    - `export`
        - containing exported probabilities, e.g. Hdf5 or Tiff stacks 

### Training and Applying a Classifier

To train a pixel classifier, the freehand line tool from ImageJ is used to draw labels on the image. One can assign labels to a certain class by either
- clicking the respective button in the "Labels" window, or
- typing the keyboard short-cuts 1,2,... 

Once a couple of labels have been added one can click __[Train Classifier]__, which will compute image features and train a random forest classifier. 
Subsequently, one can use either ImageJ's freehand line or the rectangle selection tool to select a region of interest and click __[Apply Classifier]__. The __Classification Range__ selection can be used to further specify the extend of the region to be classified.

### Actions

There are several actions available, which can be executed by clicking the __[Execute Action]__ button.

#### Add class

Adds a new pixel probability class. 

#### Change class names

Changes the class names.
  	
#### Change class colors

Changes the colors of the pixel probability overlays.

#### Export results

Presents several options to export the current pixel probabilities.

#### Review labels

When adding many labels in a large data set, it is very possible to make mistakes, i.e. by accident assign a label to a wrong class. The review labels action allows to browse through all added labels and remove false labels, using ImageJ's ROI Manager user interface.

#### Save classifier

Saves the current pixel classifier to disk such that it can be reused, e.g. using the Java API of CATS or using the "Apply classifier on cluster" action (s. b.).

#### Load classifier

Loads a classifier such that it can be applied on the current image.

#### Change feature settings

Shows a user interface for changing the image feature settings.

#### Apply classifier on slurm cluster

Applies the current cluster by sending jobs to a slurm managed computer cluster.
In addition to access to such a cluster, this also requires that all data (input image, output probabilities, and a classifier) are stored in a location that is accessible to the cluster nodes.

### Further information

#### Continue working on an existing project

- Open your input image in ImageJ
- Start CATS
- Choose the corresponding probabilities folder 
- Use the "Load labels" action to load your annotations.

#### Logging

Information about what is happening is printed into ImageJ's log window.
In addition, when you chose to save your classification results to disk (see above), another folder with the ending "--log" will be automatically created next to your results folder. The content of the logging window will be constantly written into a file in this folder.
  
